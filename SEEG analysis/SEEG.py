#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Tue May 10 16:09:02 2022

@author: justo
"""
from IPython import get_ipython
get_ipython().magic('reset -sf')

import os
import mne
import re
import random
import numpy as np
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
from itertools import groupby
from scipy.stats import wilcoxon, normaltest, ranksums, mannwhitneyu
from matplotlib.colors import TwoSlopeNorm
from mne.stats import permutation_cluster_1samp_test as pcluster_test

import analysis_combined as analysis

sns.set_theme()


decimation_factor = 5


# Load subject
fileDir = r'data_context/'
print('Now running analysis for: '+fileDir)
subj = input('Subject code:')
file_name = [_ for _ in os.listdir(fileDir) if _.endswith(r".EDF") and "P00"+str(subj) in _][0]
sub = analysis.subject(fileDir,subj,tmin ='et_looking_Start', tmax = 'et_decision_Start')
sub.psychometric_curve()
n_trials = len(sub.trials)
LaS_index = (sub.trials[sub.trials['LaN'] == 1].trial_number + 1).tolist()
LaN_index = (sub.trials[sub.trials['LaN'] == 0].trial_number + 1).tolist()

# Load EDF file
print('Loading EDF+ file...')
raw = mne.io.read_raw_edf(fileDir+file_name,preload=True)
Fs = raw.info['sfreq']

# Check the raw signal
raw.plot_psd()
raw.plot()

# Notch filter
raw.notch_filter(np.arange(50, 251, 50),phase='zero-double')

# Low pass filter to remove any possible low drift 
raw.filter(l_freq=1.,h_freq=None,phase='zero-double')

#%% Set channel types


print('Setting channel types...')

channels = raw.info.ch_names
bad = []

for channel in range(len(channels)):
    label = channels[channel]
    
    try:
        num = int(re.search(r'\d+', label).group()) 
    except: 
        num = 0
    if num > 20:
        bad.append(label)

raw.drop_channels(bad)
channels = raw.info.ch_names
channel_types = {}

for channel in range(len(channels)): 
    label = channels[channel]       
    if label == 'TTL':
        channel_types[label] = 'stim' 
    elif 'ECG' in label: 
        channel_types[label] = 'ecg'
    else:
        channel_types[label] = 'seeg'

raw.set_channel_types(channel_types)

# ref_question = input('Reference by avg of specific channel? [A/S]: ')
ref_question = 'A'

if ref_question == 'S':
    ref_channel = str(input('Reference channel:'))
    raw.set_eeg_reference(ref_channels=[ref_channel])

# Check the filtered signal
raw.plot_psd(picks=['seeg'])
raw.plot()

#%% ICA to remove noise from signal

# ica_question = input('Use ICA? [Y/N]: ')
ica_question = 'N'

if ica_question == 'Y':
    print('Performing ICA...')
    ica_components = int(input('Number of components for the ICA:'))
    ica = mne.preprocessing.ICA(n_components=ica_components,method='picard')
    ica.fit(raw)
    
    # Plot ICs
    ica.plot_sources(raw, show_scrollbars=False)
    
    # Copy and reconstruct the signal exluding the ICs
    ica.exclude = np.arange(ica_components)
    reconst_raw = raw.copy()
    ica.apply(reconst_raw)
    
    # Compare raw and ICA filtered signal 
    raw.plot()
    reconst_raw.plot()
else:
    reconst_raw = raw.copy()

#%% Obtain events from annotations 
_, event_id = mne.events_from_annotations(raw)

# Change events id so that: 0 for LaN, 1 for LaS
LaS_event_id = {key: 1 for key in event_id if 'TRIAL ' in key and int(key.split()[-1]) in LaS_index}
LaN_event_id = {key: 0 for key in event_id if 'TRIAL ' in key and int(key.split()[-1]) in LaN_index}
event_dict = LaS_event_id | LaN_event_id
events, _ = mne.events_from_annotations(raw, event_id=event_dict)
event_id = dict(LaN=0,LaS=1)

epochs = mne.Epochs(reconst_raw, events, event_id, baseline=None, detrend=1, tmax=11, preload=True)


#%% PSD for condition and electrode


epochs = mne.Epochs(reconst_raw, events, event_id, baseline=(4,5), detrend=1, tmax=11, preload=True).pick_types(seeg=True) 

PSDdf = pd.DataFrame(index=epochs.ch_names)
freqs = [[0,3,'delta'],[3,7,'theta'],[7,13,'alpha'],[13,35,'beta'],[35,140,'gamma']]
conditions = ['LaS','LaN']
counter = 0
for condition in conditions:
    print('Computing PSD for '+condition)
    selected_epochs = epochs[condition]
    selected_epochs = selected_epochs.crop(tmin=8,tmax=11)
    for freq in freqs:
        psds,_ = mne.time_frequency.psd_welch(selected_epochs,fmin=freq[0], fmax=freq[1],  n_per_seg = 128, n_overlap = 128/2, verbose=False)
        psds_means = np.mean(psds,axis=(0,2))
        psds_log10 = np.log10(psds_means)
        psds_norm = (psds_log10 - np.min(psds_log10))/np.ptp(psds_log10)
        PSDdf[freq[2]+'_'+condition] = psds_norm

PSDdf.to_csv('P00'+str(subj)+'_Normativity_Map.csv')


#%% Channels of interest


# all channels names
all_channels = epochs.pick_types(seeg=True) 
# select just the single electrode names (not the specific contact)
single_electrodes = np.unique([ ''.join((x for x in name if not x.isdigit())) for name in all_channels.ch_names if ''.join((x for x in name if not x.isdigit())) != 'C']).tolist()
#  list of lists for each electrode and its contacts
all_electrodes = [[name for name in all_channels.ch_names if electrode == ''.join((x for x in name if not x.isdigit()))] for electrode in single_electrodes]


# %% Keep just channels in the cortex


print('\nParticipant: '+str(subj))
print('Task '+fileDir)
print('Introduce this list in the 3DSlicer workflow:\n nodes=')
print(list(np.concatenate(all_electrodes).flat))
print('\nPath:')
print('exec(open("/Volumes/GoogleDrive/Mi unidad/_BRAIN+COGNITION/0_TFM/Experiments/Analysis/SlicerSingle_v04.py").read(), globals())')
print('\nCommand: showNodes(nodes)')


# %% Change nodes for the sub 


input('Remember to add the variable for the subject! [Press Enter]')

if float(subj)==2:
    all_cortical_electrodes = all_electrodes
    cortical_channels = all_channels.ch_names
    
else:

    if float(subj)==4:
        subject_nodes = [['Node', 'R', 'A', 'S', 'i', 'j', 'k', 'Anatomical Label', 'Anatomic Region'], ["F'1", -26.34000015258789, 31.809999465942383, 29.020000457763672, 154, 98, 159, 2, 'Left-Cerebral-White-Matter'], ["F'2", -29.793854658271997, 31.77436820689169, 29.585349435779957, 157, 98, 159, 2, 'Left-Cerebral-White-Matter'], ["F'3", -33.2477091639561, 31.738736947840998, 30.150698413796245, 161, 97, 159, 3, 'Left-Cerebral-Cortex'], ["F'4", -36.70156366964021, 31.703105688790306, 30.71604739181253, 164, 97, 159, 3, 'Left-Cerebral-Cortex'], ["F'5", -40.155418175324314, 31.667474429739613, 31.28139636982882, 168, 96, 159, 3, 'Left-Cerebral-Cortex'], ["F'6", -43.60927268100842, 31.631843170688917, 31.846745347845104, 171, 96, 159, 2, 'Left-Cerebral-White-Matter'], ["F'7", -47.063127186692526, 31.596211911638225, 32.41209432586139, 175, 95, 159, 2, 'Left-Cerebral-White-Matter'], ["F'8", -50.51698169237663, 31.560580652587532, 32.97744330387768, 178, 95, 159, 3, 'Left-Cerebral-Cortex'], ["HA'1", -20.43000030517578, 11.84000015258789, -8.270000457763672, 148, 136, 139, 17, 'Left-Hippocampus'], ["HA'2", -23.91220701212441, 11.760454825452118, -7.926621671271449, 151, 135, 139, 17, 'Left-Hippocampus'], ["HA'3", -27.394413719073032, 11.680909498316346, -7.583242884779225, 155, 135, 139, 17, 'Left-Hippocampus'], ["HA'4", -30.87662042602166, 11.601364171180574, -7.239864098287002, 158, 135, 139, 5, 'Left-Inf-Lat-Vent'], ["HA'5", -34.35882713297028, 11.521818844044802, -6.8964853117947795, 162, 134, 139, 2, 'Left-Cerebral-White-Matter'], ["HA'6", -37.84103383991891, 11.442273516909031, -6.553106525302557, 165, 134, 139, 2, 'Left-Cerebral-White-Matter'], ["HA'7", -41.32324054686754, 11.362728189773259, -6.209727738810333, 169, 134, 139, 2, 'Left-Cerebral-White-Matter'], ["HA'8", -44.80544725381617, 11.283182862637487, -5.86634895231811, 172, 133, 139, 2, 'Left-Cerebral-White-Matter'], ["HA'9", -48.287653960764786, 11.203637535501715, -5.522970165825887, 176, 133, 139, 3, 'Left-Cerebral-Cortex'], ["HA'10", -51.76986066771342, 11.124092208365942, -5.179591379333663, 179, 133, 139, 3, 'Left-Cerebral-Cortex'], ["HA'11", -55.25206737466204, 11.04454688123017, -4.836212592841441, 183, 132, 139, 3, 'Left-Cerebral-Cortex'], ["HA'12", -58.73427408161067, 10.965001554094398, -4.492833806349218, 186, 132, 138, 3, 'Left-Cerebral-Cortex'], ["HP'1", -11.501999855041504, -16.342750549316406, 5.6479997634887695, 139, 122, 111, 17, 'Left-Hippocampus'], ["HP'2", -14.894704503345976, -17.148658788016107, 5.347887984031215, 142, 122, 110, 17, 'Left-Hippocampus'], ["HP'3", -18.287409151650447, -17.95456702671581, 5.04777620457366, 146, 122, 110, 17, 'Left-Hippocampus'], ["HP'4", -21.680113799954917, -18.760475265415515, 4.747664425116105, 149, 123, 109, 2, 'Left-Cerebral-White-Matter'], ["HP'5", -25.07281844825939, -19.566383504115215, 4.447552645658551, 153, 123, 108, 2, 'Left-Cerebral-White-Matter'], ["HP'6", -28.46552309656386, -20.372291742814916, 4.147440866200997, 156, 123, 107, 2, 'Left-Cerebral-White-Matter'], ["HP'7", -31.858227744868334, -21.17819998151462, 3.847329086743441, 159, 124, 106, 2, 'Left-Cerebral-White-Matter'], ["HP'8", -35.2509323931728, -21.984108220214324, 3.547217307285887, 163, 124, 106, 2, 'Left-Cerebral-White-Matter'], ["HP'9", -38.64363704147728, -22.790016458914025, 3.247105527828332, 166, 124, 105, 2, 'Left-Cerebral-White-Matter'], ["HP'10", -42.03634168978175, -23.595924697613725, 2.9469937483707773, 170, 125, 104, 2, 'Left-Cerebral-White-Matter'], ["HP'11", -45.429046338086216, -24.40183293631343, 2.646881968913223, 173, 125, 103, 2, 'Left-Cerebral-White-Matter'], ["HP'12", -48.82175098639069, -25.207741175013133, 2.3467701894556683, 176, 125, 102, 2, 'Left-Cerebral-White-Matter'], ["HP'13", -52.21445563469516, -26.013649413712834, 2.046658409998113, 180, 125, 101, 3, 'Left-Cerebral-Cortex'], ["HP'14", -55.60716028299963, -26.819557652412534, 1.7465466305405588, 183, 126, 101, 0, 'Unknown'], ["HP'15", -58.9998649313041, -27.62546589111224, 1.446434851083004, 186, 126, 100, 0, 'Unknown'], ["IC'1", -34.12595748901367, 19.8756046295166, 0.6579999923706055, 162, 127, 147, 2, 'Left-Cerebral-White-Matter'], ["IC'2", -33.75455448355482, 18.645327513840027, 3.913530367928275, 161, 124, 146, 2, 'Left-Cerebral-White-Matter'], ["IC'3", -33.38315147809597, 17.41505039816345, 7.169060743485945, 161, 120, 145, 2, 'Left-Cerebral-White-Matter'], ["IC'4", -33.011748472637116, 16.184773282486876, 10.424591119043614, 161, 117, 144, 2, 'Left-Cerebral-White-Matter'], ["IC'5", -32.64034546717827, 14.954496166810301, 13.680121494601284, 160, 114, 142, 2, 'Left-Cerebral-White-Matter'], ["IC'6", -32.26894246171942, 13.724219051133726, 16.935651870158956, 160, 111, 141, 3, 'Left-Cerebral-Cortex'], ["IC'7", -31.897539456260567, 12.493941935457151, 20.19118224571662, 159, 107, 140, 2, 'Left-Cerebral-White-Matter'], ["IC'8", -31.526136450801715, 11.263664819780576, 23.44671262127429, 159, 104, 139, 3, 'Left-Cerebral-Cortex'], ["IC'9", -31.154733445342863, 10.033387704104, 26.702242996831963, 159, 101, 138, 3, 'Left-Cerebral-Cortex'], ["IC'10", -30.78333043988401, 8.803110588427424, 29.957773372389635, 158, 98, 136, 2, 'Left-Cerebral-White-Matter'], ["IC'11", -30.411927434425163, 7.572833472750849, 33.21330374794731, 158, 94, 135, 2, 'Left-Cerebral-White-Matter'], ["IC'12", -30.04052442896631, 6.342556357074274, 36.46883412350497, 158, 91, 134, 2, 'Left-Cerebral-White-Matter'], ["IC'13", -29.66912142350746, 5.112279241397699, 39.72436449906264, 157, 88, 133, 2, 'Left-Cerebral-White-Matter'], ["IC'14", -29.29771841804861, 3.882002125721124, 42.979894874620314, 157, 85, 131, 2, 'Left-Cerebral-White-Matter'], ["IC'15", -28.92631541258976, 2.651725010044551, 46.235425250177975, 156, 81, 130, 2, 'Left-Cerebral-White-Matter'], ["IC'16", -28.554912407130907, 1.4214478943679758, 49.49095562573565, 156, 78, 129, 2, 'Left-Cerebral-White-Matter'], ["IC'17", -28.183509401672055, 0.1911707786913972, 52.74648600129332, 156, 75, 128, 2, 'Left-Cerebral-White-Matter'], ["IC'18", -27.812106396213206, -1.0391063369851743, 56.00201637685098, 155, 71, 126, 2, 'Left-Cerebral-White-Matter'], ["IF'1", -35.021915435791016, 26.796520233154297, 6.6479997634887695, 163, 121, 154, 3, 'Left-Cerebral-Cortex'], ["IF'2", -34.15873417988489, 26.280817346567552, 10.000456870182072, 162, 117, 154, 3, 'Left-Cerebral-Cortex'], ["IF'3", -33.29555292397877, 25.765114459980808, 13.352913976875374, 161, 114, 153, 2, 'Left-Cerebral-White-Matter'], ["IF'4", -32.43237166807264, 25.249411573394063, 16.70537108356868, 160, 111, 153, 3, 'Left-Cerebral-Cortex'], ["IF'5", -31.56919041216652, 24.73370868680732, 20.05782819026198, 159, 107, 152, 2, 'Left-Cerebral-White-Matter'], ["IF'6", -30.706009156260397, 24.218005800220574, 23.41028529695528, 158, 104, 152, 3, 'Left-Cerebral-Cortex'], ["IF'7", -29.842827900354273, 23.702302913633826, 26.762742403648584, 157, 101, 151, 2, 'Left-Cerebral-White-Matter'], ["IF'8", -28.979646644448145, 23.18660002704708, 30.115199510341885, 156, 97, 151, 2, 'Left-Cerebral-White-Matter'], ["IF'9", -28.116465388542025, 22.670897140460337, 33.46765661703519, 156, 94, 150, 2, 'Left-Cerebral-White-Matter'], ["IF'10", -27.253284132635898, 22.155194253873592, 36.82011372372849, 155, 91, 150, 2, 'Left-Cerebral-White-Matter'], ["IF'11", -26.390102876729777, 21.639491367286848, 40.17257083042179, 154, 87, 149, 2, 'Left-Cerebral-White-Matter'], ["IF'12", -25.52692162082365, 21.123788480700103, 43.52502793711509, 153, 84, 149, 2, 'Left-Cerebral-White-Matter'], ["IF'13", -24.663740364917526, 20.608085594113355, 46.8774850438084, 152, 81, 148, 2, 'Left-Cerebral-White-Matter'], ["IF'14", -23.800559109011402, 20.09238270752661, 50.22994215050169, 151, 77, 148, 2, 'Left-Cerebral-White-Matter'], ["IF'15", -22.93737785310528, 19.576679820939866, 53.582399257195, 150, 74, 147, 2, 'Left-Cerebral-White-Matter'], ["IF'16", -22.074196597199155, 19.06097693435312, 56.934856363888294, 150, 71, 147, 3, 'Left-Cerebral-Cortex'], ["IF'17", -21.21101534129303, 18.545274047766377, 60.2873134705816, 149, 67, 146, 0, 'Unknown'], ["IF'18", -20.347834085386907, 18.029571161179632, 63.639770577274895, 148, 64, 146, 3, 'Left-Cerebral-Cortex'], ["IP'1", -31.8629150390625, 8.495521545410156, 5.690999984741211, 159, 122, 136, 2, 'Left-Cerebral-White-Matter'], ["IP'2", -31.54365927693893, 6.74974649309963, 8.707677830498207, 159, 119, 134, 2, 'Left-Cerebral-White-Matter'], ["IP'3", -31.224403514815354, 5.003971440789103, 11.724355676255204, 159, 116, 133, 2, 'Left-Cerebral-White-Matter'], ["IP'4", -30.905147752691782, 3.2581963884785754, 14.741033522012202, 158, 113, 131, 2, 'Left-Cerebral-White-Matter'], ["IP'5", -30.585891990568207, 1.5124213361680487, 17.757711367769197, 158, 110, 129, 3, 'Left-Cerebral-Cortex'], ["IP'6", -30.266636228444636, -0.2333537161424779, 20.774389213526195, 158, 107, 127, 3, 'Left-Cerebral-Cortex'], ["IP'7", -29.947380466321064, -1.9791287684530054, 23.791067059283193, 157, 104, 126, 3, 'Left-Cerebral-Cortex'], ["IP'8", -29.62812470419749, -3.724903820763531, 26.807744905040188, 157, 101, 124, 3, 'Left-Cerebral-Cortex'], ["IP'9", -29.308868942073918, -5.470678873074059, 29.824422750797186, 157, 98, 122, 2, 'Left-Cerebral-White-Matter'], ["IP'10", -28.989613179950343, -7.216453925384586, 32.841100596554185, 156, 95, 120, 2, 'Left-Cerebral-White-Matter'], ["IP'11", -28.67035741782677, -8.962228977695112, 35.85777844231118, 156, 92, 119, 2, 'Left-Cerebral-White-Matter'], ["IP'12", -28.351101655703197, -10.70800403000564, 38.874456288068174, 156, 89, 117, 2, 'Left-Cerebral-White-Matter'], ["IP'13", -28.031845893579625, -12.453779082316167, 41.891134133825176, 156, 86, 115, 2, 'Left-Cerebral-White-Matter'], ["IP'14", -27.712590131456054, -14.199554134626695, 44.90781197958217, 155, 83, 113, 2, 'Left-Cerebral-White-Matter'], ["IP'15", -27.39333436933248, -15.945329186937219, 47.924489825339165, 155, 80, 112, 2, 'Left-Cerebral-White-Matter'], ["IP'16", -27.074078607208907, -17.691104239247746, 50.94116767109617, 155, 77, 110, 2, 'Left-Cerebral-White-Matter'], ["IP'17", -26.754822845085336, -19.436879291558274, 53.95784551685316, 154, 74, 108, 2, 'Left-Cerebral-White-Matter'], ["IP'18", -26.43556708296176, -21.1826543438688, 56.97452336261016, 154, 71, 106, 2, 'Left-Cerebral-White-Matter'], ["O'1", -2.568915605545044, -56.72035217285156, -2.0980000495910645, 130, 130, 71, 2, 'Left-Cerebral-White-Matter'], ["O'2", -6.053530659759835, -56.63181620055919, -1.7823747883240082, 134, 129, 71, 2, 'Left-Cerebral-White-Matter'], ["O'3", -9.538145713974625, -56.54328022826682, -1.466749527056952, 137, 129, 71, 2, 'Left-Cerebral-White-Matter'], ["O'4", -13.022760768189416, -56.454744255974454, -1.1511242657898957, 141, 129, 71, 2, 'Left-Cerebral-White-Matter'], ["O'5", -16.507375822404207, -56.366208283682084, -0.8354990045228397, 144, 128, 71, 2, 'Left-Cerebral-White-Matter'], ["O'6", -19.991990876618996, -56.277672311389715, -0.5198737432557834, 147, 128, 71, 2, 'Left-Cerebral-White-Matter'], ["O'7", -23.476605930833788, -56.189136339097345, -0.20424848198872692, 151, 128, 71, 3, 'Left-Cerebral-Cortex'], ["O'8", -26.961220985048577, -56.100600366804976, 0.11137677927832934, 154, 127, 71, 3, 'Left-Cerebral-Cortex'], ["O'9", -30.445836039263366, -56.012064394512606, 0.42700204054538515, 158, 127, 71, 2, 'Left-Cerebral-White-Matter'], ["O'10", -33.930451093478155, -55.92352842222024, 0.7426273018124414, 161, 127, 72, 2, 'Left-Cerebral-White-Matter'], ["O'11", -37.41506614769295, -55.83499244992787, 1.0582525630794977, 165, 126, 72, 3, 'Left-Cerebral-Cortex'], ["O'12", -40.89968120190774, -55.7464564776355, 1.373877824346554, 168, 126, 72, 3, 'Left-Cerebral-Cortex'], ["OP'1", -32.258914947509766, 1.0616055727005005, 30.077999114990234, 160, 97, 129, 2, 'Left-Cerebral-White-Matter'], ["OP'2", -35.700599761614924, 1.1239480648265947, 29.444817423819817, 163, 98, 129, 2, 'Left-Cerebral-White-Matter'], ["OP'3", -39.14228457572009, 1.186290556952689, 28.811635732649403, 167, 99, 129, 3, 'Left-Cerebral-Cortex'], ["OP'4", -42.58396938982525, 1.2486330490787831, 28.178454041478986, 170, 99, 129, 2, 'Left-Cerebral-White-Matter'], ["OP'5", -46.02565420393041, 1.3109755412048774, 27.54527235030857, 174, 100, 129, 2, 'Left-Cerebral-White-Matter'], ["OP'6", -49.467339018035574, 1.3733180333309716, 26.912090659138155, 177, 101, 129, 2, 'Left-Cerebral-White-Matter'], ["OP'7", -52.90902383214073, 1.4356605254570656, 26.278908967967737, 180, 101, 129, 2, 'Left-Cerebral-White-Matter'], ["OP'8", -56.35070864624589, 1.4980030175831598, 25.64572727679732, 184, 102, 129, 3, 'Left-Cerebral-Cortex'], ["OS'1", -2.3959999084472656, -52.637351989746094, 8.406000137329102, 130, 119, 75, 2, 'Left-Cerebral-White-Matter'], ["OS'2", -5.784128700311376, -53.044333614792606, 9.183784970439095, 133, 118, 74, 3, 'Left-Cerebral-Cortex'], ["OS'3", -9.172257492175486, -53.451315239839126, 9.961569803549091, 137, 118, 74, 2, 'Left-Cerebral-White-Matter'], ["OS'4", -12.560386284039597, -53.85829686488564, 10.739354636659087, 140, 117, 74, 2, 'Left-Cerebral-White-Matter'], ["OS'5", -15.948515075903707, -54.26527848993215, 11.51713946976908, 143, 116, 73, 3, 'Left-Cerebral-Cortex'], ["OS'6", -19.336643867767815, -54.67226011497866, 12.294924302879075, 147, 115, 73, 3, 'Left-Cerebral-Cortex'], ["OS'7", -22.724772659631927, -55.07924174002518, 13.07270913598907, 150, 114, 72, 0, 'Unknown'], ["OS'8", -26.112901451496036, -55.486223365071695, 13.850493969099066, 154, 114, 72, 0, 'Unknown'], ["OS'9", -29.501030243360148, -55.89320499011821, 14.62827880220906, 157, 113, 72, 2, 'Left-Cerebral-White-Matter'], ["OS'10", -32.88915903522425, -56.30018661516472, 15.406063635319054, 160, 112, 71, 3, 'Left-Cerebral-Cortex'], ["OS'11", -36.277287827088365, -56.70716824021124, 16.183848468429048, 164, 111, 71, 3, 'Left-Cerebral-Cortex'], ["OS'12", -39.66541661895248, -57.11414986525775, 16.961633301539045, 167, 111, 70, 0, 'Unknown'], ["P'1", -1.9479577541351318, -22.994394302368164, 28.400999069213867, 129, 99, 105, 3, 'Left-Cerebral-Cortex'], ["P'2", -5.400780842345379, -23.10286660227958, 28.96335703499205, 133, 99, 104, 2, 'Left-Cerebral-White-Matter'], ["P'3", -8.853603930555627, -23.211338902191, 29.525715000770234, 136, 98, 104, 2, 'Left-Cerebral-White-Matter'], ["P'4", -12.306427018765875, -23.319811202102414, 30.088072966548417, 140, 97, 104, 2, 'Left-Cerebral-White-Matter'], ["P'5", -15.759250106976122, -23.42828350201383, 30.650430932326596, 143, 97, 104, 2, 'Left-Cerebral-White-Matter'], ["P'6", -19.21207319518637, -23.53675580192525, 31.21278889810478, 147, 96, 104, 2, 'Left-Cerebral-White-Matter'], ["P'7", -22.66489628339662, -23.645228101836665, 31.775146863882963, 150, 96, 104, 2, 'Left-Cerebral-White-Matter'], ["P'8", -26.117719371606867, -23.75370040174808, 32.33750482966114, 154, 95, 104, 2, 'Left-Cerebral-White-Matter'], ["P'9", -29.570542459817112, -23.862172701659496, 32.899862795439326, 157, 95, 104, 2, 'Left-Cerebral-White-Matter'], ["P'10", -33.02336554802736, -23.970645001570915, 33.46222076121751, 161, 94, 104, 2, 'Left-Cerebral-White-Matter'], ["P'11", -36.47618863623761, -24.07911730148233, 34.02457872699569, 164, 93, 103, 2, 'Left-Cerebral-White-Matter'], ["P'12", -39.92901172444786, -24.187589601393746, 34.586936692773875, 167, 93, 103, 2, 'Left-Cerebral-White-Matter'], ["P'13", -43.381834812658106, -24.296061901305166, 35.14929465855206, 171, 92, 103, 3, 'Left-Cerebral-Cortex'], ["P'14", -46.83465790086836, -24.40453420121658, 35.71165262433024, 174, 92, 103, 2, 'Left-Cerebral-White-Matter'], ["P'15", -50.2874809890786, -24.513006501127997, 36.274010590108425, 178, 91, 103, 3, 'Left-Cerebral-Cortex'], ["PI'1", -2.364000082015991, -14.061521530151367, 32.53099822998047, 130, 95, 113, 2, 'Left-Cerebral-White-Matter'], ["PI'2", -5.856584641289487, -13.84027047106404, 32.47713669289606, 133, 95, 114, 2, 'Left-Cerebral-White-Matter'], ["PI'3", -9.349169200562983, -13.619019411976714, 32.42327515581165, 137, 95, 114, 2, 'Left-Cerebral-White-Matter'], ["PI'4", -12.84175375983648, -13.397768352889386, 32.36941361872724, 140, 95, 114, 2, 'Left-Cerebral-White-Matter'], ["PI'5", -16.334338319109975, -13.17651729380206, 32.315552081642835, 144, 95, 114, 2, 'Left-Cerebral-White-Matter'], ["PI'6", -19.826922878383474, -12.955266234714733, 32.26169054455843, 147, 95, 115, 2, 'Left-Cerebral-White-Matter'], ["PI'7", -23.31950743765697, -12.734015175627407, 32.20782900747402, 151, 95, 115, 2, 'Left-Cerebral-White-Matter'], ["PI'8", -26.81209199693047, -12.51276411654008, 32.15396747038961, 154, 95, 115, 2, 'Left-Cerebral-White-Matter'], ["PI'9", -30.30467655620396, -12.291513057452754, 32.1001059333052, 158, 95, 115, 2, 'Left-Cerebral-White-Matter'], ["PI'10", -33.797261115477454, -12.070261998365426, 32.04624439622079, 161, 95, 115, 2, 'Left-Cerebral-White-Matter'], ["PI'11", -37.28984567475096, -11.849010939278099, 31.992382859136384, 165, 96, 116, 2, 'Left-Cerebral-White-Matter'], ["PI'12", -40.78243023402445, -11.627759880190773, 31.938521322051976, 168, 96, 116, 2, 'Left-Cerebral-White-Matter'], ["PI'13", -44.27501479329795, -11.406508821103447, 31.884659784967567, 172, 96, 116, 2, 'Left-Cerebral-White-Matter'], ["PI'14", -47.76759935257144, -11.18525776201612, 31.830798247883155, 175, 96, 116, 2, 'Left-Cerebral-White-Matter'], ["PI'15", -51.26018391184495, -10.964006702928792, 31.776936710798747, 179, 96, 117, 3, 'Left-Cerebral-Cortex'], ["PI'16", -54.752768471118436, -10.742755643841466, 31.72307517371434, 182, 96, 117, 3, 'Left-Cerebral-Cortex'], ["PI'17", -58.24535303039193, -10.521504584754139, 31.66921363662993, 186, 96, 117, 0, 'Unknown'], ["PI'18", -61.73793758966543, -10.300253525666813, 31.61535209954552, 189, 96, 117, 0, 'Unknown'], ["S'1", -1.340042233467102, -8.767605781555176, 33.06100082397461, 129, 94, 119, 3, 'Left-Cerebral-Cortex'], ["S'2", -4.796037883124191, -8.484023728658286, 33.53605375663165, 132, 94, 119, 2, 'Left-Cerebral-White-Matter'], ["S'3", -8.25203353278128, -8.200441675761395, 34.011106689288695, 136, 93, 119, 2, 'Left-Cerebral-White-Matter'], ["S'4", -11.70802918243837, -7.916859622864505, 34.48615962194574, 139, 93, 120, 2, 'Left-Cerebral-White-Matter'], ["S'5", -15.164024832095459, -7.633277569967615, 34.96121255460278, 143, 93, 120, 2, 'Left-Cerebral-White-Matter'], ["S'6", -18.620020481752547, -7.3496955170707245, 35.436265487259824, 146, 92, 120, 2, 'Left-Cerebral-White-Matter'], ["S'7", -22.076016131409638, -7.066113464173835, 35.91131841991687, 150, 92, 120, 2, 'Left-Cerebral-White-Matter'], ["S'8", -25.532011781066725, -6.782531411276945, 36.3863713525739, 153, 91, 121, 2, 'Left-Cerebral-White-Matter'], ["S'9", -28.988007430723815, -6.498949358380054, 36.86142428523095, 156, 91, 121, 2, 'Left-Cerebral-White-Matter'], ["S'10", -32.44400308038091, -6.215367305483165, 37.33647721788799, 160, 90, 121, 2, 'Left-Cerebral-White-Matter'], ["S'11", -35.89999873003799, -5.931785252586274, 37.81153015054503, 163, 90, 122, 2, 'Left-Cerebral-White-Matter'], ["S'12", -39.35599437969508, -5.648203199689384, 38.286583083202075, 167, 89, 122, 2, 'Left-Cerebral-White-Matter'], ["S'13", -42.811990029352174, -5.364621146792493, 38.76163601585912, 170, 89, 122, 2, 'Left-Cerebral-White-Matter'], ["S'14", -46.267985679009264, -5.081039093895603, 39.23668894851616, 174, 88, 122, 2, 'Left-Cerebral-White-Matter'], ["S'15", -49.72398132866635, -4.797457040998713, 39.711741881173204, 177, 88, 123, 2, 'Left-Cerebral-White-Matter'], ["TI'1", -38.95195770263672, 10.559563636779785, 6.364999771118164, 166, 121, 138, 3, 'Left-Cerebral-Cortex'], ["TI'2", -42.3182835704693, 9.627714315101686, 6.587501441335041, 170, 121, 137, 0, 'Unknown'], ["TI'3", -45.68460943830188, 8.695864993423587, 6.810003111551918, 173, 121, 136, 3, 'Left-Cerebral-Cortex'], ["TI'4", -49.050935306134456, 7.7640156717454865, 7.032504781768796, 177, 120, 135, 2, 'Left-Cerebral-White-Matter'], ["TI'5", -52.417261173967034, 6.8321663500673875, 7.255006451985673, 180, 120, 134, 2, 'Left-Cerebral-White-Matter'], ["TI'6", -55.78358704179961, 5.9003170283892885, 7.47750812220255, 183, 120, 133, 3, 'Left-Cerebral-Cortex'], ["TI'7", -59.14991290963219, 4.968467706711189, 7.7000097924194275, 187, 120, 132, 0, 'Unknown'], ["TI'8", -62.51623877746477, 4.036618385033089, 7.9225114626363045, 190, 120, 132, 0, 'Unknown'], ["TP'1", -8.308084487915039, -40.13751983642578, 1.7200000286102295, 136, 126, 87, 2, 'Left-Cerebral-White-Matter'], ["TP'2", -11.803183956102252, -40.322631653277455, 1.7236500613940826, 139, 126, 87, 2, 'Left-Cerebral-White-Matter'], ["TP'3", -15.298283424289467, -40.50774347012912, 1.7273000941779355, 143, 126, 87, 2, 'Left-Cerebral-White-Matter'], ["TP'4", -18.793382892476682, -40.692855286980794, 1.7309501269617886, 146, 126, 87, 3, 'Left-Cerebral-Cortex'], ["TP'5", -22.288482360663895, -40.87796710383247, 1.7346001597456415, 150, 126, 87, 2, 'Left-Cerebral-White-Matter'], ["TP'6", -25.78358182885111, -41.063078920684134, 1.7382501925294946, 153, 126, 86, 2, 'Left-Cerebral-White-Matter'], ["TP'7", -29.278681297038325, -41.24819073753581, 1.7419002253133475, 157, 126, 86, 2, 'Left-Cerebral-White-Matter'], ["TP'8", -32.77378076522554, -41.433302554387474, 1.7455502580972007, 160, 126, 86, 2, 'Left-Cerebral-White-Matter'], ["TP'9", -36.26888023341275, -41.61841437123915, 1.7492002908810536, 164, 126, 86, 3, 'Left-Cerebral-Cortex'], ["TP'10", -39.763979701599965, -41.80352618809082, 1.7528503236649067, 167, 126, 86, 3, 'Left-Cerebral-Cortex'], ["TP'11", -43.25907916978718, -41.98863800494249, 1.7565003564487598, 171, 126, 86, 3, 'Left-Cerebral-Cortex'], ["TP'12", -46.7541786379744, -42.17374982179416, 1.7601503892326127, 174, 126, 85, 3, 'Left-Cerebral-Cortex'], ["TP'13", -50.24927810616161, -42.358861638645834, 1.7638004220164658, 178, 126, 85, 0, 'Unknown'], ["TP'14", -53.744377574348825, -42.5439734554975, 1.7674504548003187, 181, 126, 85, 0, 'Unknown'], ["TP'15", -57.23947704253604, -42.729085272349174, 1.7711004875841718, 185, 126, 85, 0, 'Unknown'], ["TS'1", -33.63399887084961, -9.140563011169434, 13.685999870300293, 161, 114, 118, 2, 'Left-Cerebral-White-Matter'], ["TS'2", -37.05630955691996, -9.872144946045537, 13.736768370097032, 165, 114, 118, 2, 'Left-Cerebral-White-Matter'], ["TS'3", -40.47862024299031, -10.603726880921641, 13.78753686989377, 168, 114, 117, 2, 'Left-Cerebral-White-Matter'], ["TS'4", -43.900930929060664, -11.335308815797745, 13.83830536969051, 171, 114, 116, 2, 'Left-Cerebral-White-Matter'], ["TS'5", -47.32324161513102, -12.06689075067385, 13.889073869487248, 175, 114, 115, 2, 'Left-Cerebral-White-Matter'], ["TS'6", -50.74555230120137, -12.798472685549953, 13.939842369283987, 178, 114, 115, 2, 'Left-Cerebral-White-Matter'], ["TS'7", -54.16786298727172, -13.530054620426055, 13.990610869080726, 182, 114, 114, 3, 'Left-Cerebral-Cortex'], ["TS'8", -57.59017367334207, -14.26163655530216, 14.041379368877465, 185, 113, 113, 3, 'Left-Cerebral-Cortex'], ["TS'9", -61.012484359412426, -14.993218490178263, 14.092147868674203, 189, 113, 113, 0, 'Unknown'], ["TS'10", -64.43479504548277, -15.724800425054365, 14.142916368470942, 192, 113, 112, 0, 'Unknown'], ["W'1", -2.0840423107147217, -29.120479583740234, 21.812999725341797, 130, 106, 98, 2, 'Left-Cerebral-White-Matter'], ["W'2", -5.57869156013353, -29.294871791398858, 21.72925020925657, 133, 106, 98, 2, 'Left-Cerebral-White-Matter'], ["W'3", -9.073340809552338, -29.469263999057482, 21.645500693171343, 137, 106, 98, 2, 'Left-Cerebral-White-Matter'], ["W'4", -12.567990058971146, -29.643656206716102, 21.56175117708612, 140, 106, 98, 2, 'Left-Cerebral-White-Matter'], ["W'5", -16.062639308389954, -29.818048414374726, 21.478001661000892, 144, 106, 98, 2, 'Left-Cerebral-White-Matter'], ["W'6", -19.557288557808764, -29.99244062203335, 21.394252144915665, 147, 106, 98, 2, 'Left-Cerebral-White-Matter'], ["W'7", -23.05193780722757, -30.166832829691973, 21.310502628830438, 151, 106, 97, 2, 'Left-Cerebral-White-Matter'], ["W'8", -26.546587056646384, -30.341225037350593, 21.22675311274521, 154, 106, 97, 3, 'Left-Cerebral-Cortex'], ["W'9", -30.04123630606519, -30.515617245009217, 21.143003596659987, 158, 106, 97, 3, 'Left-Cerebral-Cortex'], ["W'10", -33.535885555484, -30.69000945266784, 21.05925408057476, 161, 106, 97, 3, 'Left-Cerebral-Cortex'], ["W'11", -37.03053480490281, -30.864401660326465, 20.975504564489533, 165, 107, 97, 3, 'Left-Cerebral-Cortex'], ["W'12", -40.52518405432161, -31.038793867985085, 20.891755048404306, 168, 107, 96, 3, 'Left-Cerebral-Cortex'], ["W'13", -44.01983330374042, -31.21318607564371, 20.80800553231908, 172, 107, 96, 3, 'Left-Cerebral-Cortex'], ["W'14", -47.51448255315923, -31.387578283302332, 20.724256016233852, 175, 107, 96, 2, 'Left-Cerebral-White-Matter'], ["W'15", -51.00913180257805, -31.561970490960956, 20.64050650014863, 179, 107, 96, 3, 'Left-Cerebral-Cortex']]
    elif float(subj)==3:
        subject_nodes = [['Node', 'R', 'A', 'S', 'i', 'j', 'k', 'Anatomical Label', 'Anatomic Region'], ["A'1", -15.918999671936035, 31.309499740600586, -6.559999942779541, 143, 134, 159, 18, 'Left-Amygdala'], ["A'2", -19.3848686689214, 31.54627550609444, -6.98625025962453, 147, 134, 159, 18, 'Left-Amygdala'], ["A'3", -22.850737665906767, 31.783051271588292, -7.412500576469519, 150, 135, 159, 18, 'Left-Amygdala'], ["A'4", -26.316606662892134, 32.019827037082145, -7.838750893314508, 154, 135, 160, 18, 'Left-Amygdala'], ["A'5", -29.7824756598775, 32.256602802576, -8.265001210159497, 157, 136, 160, 18, 'Left-Amygdala'], ["A'6", -33.24834465686286, 32.49337856806985, -8.691251527004486, 161, 136, 160, 18, 'Left-Amygdala'], ["A'7", -36.71421365384823, 32.7301543335637, -9.117501843849475, 164, 137, 160, 2, 'Left-Cerebral-White-Matter'], ["A'8", -40.1800826508336, 32.966930099057556, -9.543752160694464, 168, 137, 160, 2, 'Left-Cerebral-White-Matter'], ["A'9", -43.64595164781896, 33.20370586455141, -9.970002477539454, 171, 137, 161, 2, 'Left-Cerebral-White-Matter'], ["A'10", -47.111820644804325, 33.44048163004526, -10.396252794384443, 175, 138, 161, 2, 'Left-Cerebral-White-Matter'], ["A'11", -50.57768964178969, 33.677257395539115, -10.822503111229432, 178, 138, 161, 2, 'Left-Cerebral-White-Matter'], ["A'12", -54.04355863877506, 33.91403316103297, -11.248753428074421, 182, 139, 161, 3, 'Left-Cerebral-Cortex'], ["A'13", -57.509427635760424, 34.15080892652682, -11.67500374491941, 185, 139, 162, 3, 'Left-Cerebral-Cortex'], ["A'14", -60.975296632745795, 34.387584692020674, -12.1012540617644, 188, 140, 162, 3, 'Left-Cerebral-Cortex'], ["A'15", -64.44116562973116, 34.62436045751453, -12.527504378609388, 192, 140, 162, 0, 'Unknown'], ["AU'1", -43.17660140991211, -8.816100120544434, -3.4790000915527344, 171, 131, 119, 3, 'Left-Cerebral-Cortex'], ["AU'2", -46.51845631898226, -9.726980332744843, -2.9767023653529336, 174, 130, 118, 3, 'Left-Cerebral-Cortex'], ["AU'3", -49.8603112280524, -10.637860544945253, -2.474404639153133, 177, 130, 117, 3, 'Left-Cerebral-Cortex'], ["AU'4", -53.20216613712255, -11.548740757145662, -1.9721069129533322, 181, 129, 116, 3, 'Left-Cerebral-Cortex'], ["AU'5", -56.544021046192704, -12.459620969346071, -1.4698091867535314, 184, 129, 115, 3, 'Left-Cerebral-Cortex'], ["AU'6", -59.88587595526285, -13.37050118154648, -0.9675114605537307, 187, 128, 114, 3, 'Left-Cerebral-Cortex'], ["AU'7", -63.227730864333, -14.28138139374689, -0.46521373435393, 191, 128, 113, 0, 'Unknown'], ["AU'8", -66.56958577340315, -15.192261605947301, 0.037083991845870745, 194, 127, 112, 0, 'Unknown'], ["E'1", -26.818599700927734, 13.176400184631348, -16.256000518798828, 154, 144, 141, 3, 'Left-Cerebral-Cortex'], ["E'2", -30.318297062674702, 13.135129494105884, -16.235626361518687, 158, 144, 141, 0, 'Unknown'], ["E'3", -33.81799442442167, 13.093858803580419, -16.21525220423855, 161, 144, 141, 3, 'Left-Cerebral-Cortex'], ["E'4", -37.31769178616864, 13.052588113054956, -16.194878046958408, 165, 144, 141, 3, 'Left-Cerebral-Cortex'], ["E'5", -40.8173891479156, 13.01131742252949, -16.174503889678267, 168, 144, 141, 3, 'Left-Cerebral-Cortex'], ["E'6", -44.317086509662566, 12.970046732004027, -16.15412973239813, 172, 144, 140, 2, 'Left-Cerebral-White-Matter'], ["E'7", -47.816783871409534, 12.928776041478562, -16.133755575117988, 175, 144, 140, 2, 'Left-Cerebral-White-Matter'], ["E'8", -51.316481233156495, 12.887505350953099, -16.113381417837846, 179, 144, 140, 3, 'Left-Cerebral-Cortex'], ["E'9", -54.81617859490346, 12.846234660427633, -16.09300726055771, 182, 144, 140, 0, 'Unknown'], ["E'10", -58.31587595665043, 12.80496396990217, -16.072633103277568, 186, 144, 140, 3, 'Left-Cerebral-Cortex'], ["E'11", -61.8155733183974, 12.763693279376705, -16.05225894599743, 189, 144, 140, 3, 'Left-Cerebral-Cortex'], ["E'12", -65.31527068014435, 12.722422588851241, -16.03188478871729, 193, 144, 140, 0, 'Unknown'], ["E'13", -68.81496804189133, 12.681151898325776, -16.011510631437147, 196, 144, 140, 0, 'Unknown'], ["E'14", -72.31466540363829, 12.639881207800313, -15.991136474157008, 200, 143, 140, 0, 'Unknown'], ["E'15", -75.81436276538525, 12.598610517274848, -15.970762316876868, 203, 143, 140, 0, 'Unknown'], ["HA'1", -17.166000366210938, 24.506500244140625, -6.728000164031982, 145, 134, 152, 17, 'Left-Hippocampus'], ["HA'2", -20.63720927965775, 24.775216165452665, -7.086469734345587, 148, 135, 152, 17, 'Left-Hippocampus'], ["HA'3", -24.108418193104562, 25.043932086764702, -7.444939304659191, 152, 135, 153, 18, 'Left-Amygdala'], ["HA'4", -27.579627106551378, 25.312648008076742, -7.803408874972796, 155, 135, 153, 18, 'Left-Amygdala'], ["HA'5", -31.05083601999819, 25.58136392938878, -8.1618784452864, 159, 136, 153, 18, 'Left-Amygdala'], ["HA'6", -34.522044933445, 25.85007985070082, -8.520348015600003, 162, 136, 153, 5, 'Left-Inf-Lat-Vent'], ["HA'7", -37.99325384689182, 26.11879577201286, -8.878817585913609, 165, 136, 154, 2, 'Left-Cerebral-White-Matter'], ["HA'8", -41.464462760338634, 26.387511693324896, -9.237287156227213, 169, 137, 154, 2, 'Left-Cerebral-White-Matter'], ["HA'9", -44.93567167378544, 26.656227614636936, -9.595756726540817, 172, 137, 154, 2, 'Left-Cerebral-White-Matter'], ["HA'10", -48.40688058723225, 26.924943535948973, -9.954226296854422, 176, 137, 154, 2, 'Left-Cerebral-White-Matter'], ["HA'11", -51.87808950067907, 27.193659457261013, -10.312695867168026, 179, 138, 155, 2, 'Left-Cerebral-White-Matter'], ["HA'12", -55.349298414125876, 27.46237537857305, -10.67116543748163, 183, 138, 155, 3, 'Left-Cerebral-Cortex'], ["HA'13", -58.8205073275727, 27.73109129988509, -11.029635007795235, 186, 139, 155, 3, 'Left-Cerebral-Cortex'], ["HA'14", -62.29171624101951, 27.99980722119713, -11.38810457810884, 190, 139, 155, 3, 'Left-Cerebral-Cortex'], ["HA'15", -65.76292515446633, 28.268523142509167, -11.746574148422443, 193, 139, 156, 0, 'Unknown'], ["HB'1", -28.96150016784668, 13.20930004119873, -9.11400032043457, 156, 137, 141, 17, 'Left-Hippocampus'], ["HB'2", -32.43583072898865, 13.061394218146452, -8.71757754179772, 160, 136, 141, 17, 'Left-Hippocampus'], ["HB'3", -35.91016129013062, 12.913488395094172, -8.32115476316087, 163, 136, 140, 17, 'Left-Hippocampus'], ["HB'4", -39.384491851272585, 12.765582572041893, -7.924731984524019, 167, 135, 140, 2, 'Left-Cerebral-White-Matter'], ["HB'5", -42.858822412414554, 12.617676748989613, -7.528309205887169, 170, 135, 140, 2, 'Left-Cerebral-White-Matter'], ["HB'6", -46.33315297355652, 12.469770925937334, -7.131886427250318, 174, 135, 140, 2, 'Left-Cerebral-White-Matter'], ["HB'7", -49.80748353469849, 12.321865102885054, -6.735463648613468, 177, 134, 140, 2, 'Left-Cerebral-White-Matter'], ["HB'8", -53.28181409584046, 12.173959279832776, -6.339040869976618, 181, 134, 140, 2, 'Left-Cerebral-White-Matter'], ["HB'9", -56.75614465698243, 12.026053456780495, -5.942618091339767, 184, 133, 140, 2, 'Left-Cerebral-White-Matter'], ["HB'10", -60.2304752181244, 11.878147633728217, -5.546195312702917, 188, 133, 139, 2, 'Left-Cerebral-White-Matter'], ["HB'11", -63.704805779266366, 11.730241810675937, -5.1497725340660665, 191, 133, 139, 3, 'Left-Cerebral-Cortex'], ["HB'12", -67.17913634040833, 11.582335987623658, -4.753349755429216, 195, 132, 139, 3, 'Left-Cerebral-Cortex'], ["HB'13", -70.6534669015503, 11.434430164571378, -4.356926976792366, 198, 132, 139, 0, 'Unknown'], ["HB'14", -74.12779746269229, 11.2865243415191, -3.9605041981555154, 202, 131, 139, 0, 'Unknown'], ["HB'15", -77.60212802383424, 11.138618518466819, -3.564081419518665, 205, 131, 139, 0, 'Unknown'], ["HP'1", -15.608599662780762, -6.432000160217285, -3.628999948501587, 143, 131, 121, 17, 'Left-Hippocampus'], ["HP'2", -19.04725294348691, -6.533151625210535, -4.2735400917188695, 147, 132, 121, 17, 'Left-Hippocampus'], ["HP'3", -22.48590622419306, -6.634303090203786, -4.918080234936153, 150, 132, 121, 17, 'Left-Hippocampus'], ["HP'4", -25.924559504899207, -6.735454555197036, -5.562620378153436, 153, 133, 121, 17, 'Left-Hippocampus'], ["HP'5", -29.36321278560536, -6.8366060201902865, -6.207160521370719, 157, 134, 121, 17, 'Left-Hippocampus'], ["HP'6", -32.801866066311504, -6.937757485183537, -6.8517006645880025, 160, 134, 121, 2, 'Left-Cerebral-White-Matter'], ["HP'7", -36.24051934701765, -7.038908950176787, -7.496240807805284, 164, 135, 120, 2, 'Left-Cerebral-White-Matter'], ["HP'8", -39.6791726277238, -7.140060415170037, -8.140780951022567, 167, 136, 120, 2, 'Left-Cerebral-White-Matter'], ["HP'9", -43.11782590842996, -7.241211880163288, -8.785321094239851, 171, 136, 120, 2, 'Left-Cerebral-White-Matter'], ["HP'10", -46.556479189136105, -7.342363345156538, -9.429861237457136, 174, 137, 120, 2, 'Left-Cerebral-White-Matter'], ["HP'11", -49.995132469842254, -7.4435148101497886, -10.074401380674418, 177, 138, 120, 2, 'Left-Cerebral-White-Matter'], ["HP'12", -53.4337857505484, -7.5446662751430384, -10.7189415238917, 181, 138, 120, 2, 'Left-Cerebral-White-Matter'], ["HP'13", -56.87243903125455, -7.645817740136289, -11.363481667108982, 184, 139, 120, 2, 'Left-Cerebral-White-Matter'], ["HP'14", -60.3110923119607, -7.746969205129539, -12.008021810326268, 188, 140, 120, 2, 'Left-Cerebral-White-Matter'], ["HP'15", -63.74974559266685, -7.84812067012279, -12.652561953543549, 191, 140, 120, 3, 'Left-Cerebral-Cortex'], ["PH'1", -22.095600128173828, -5.7129998207092285, -18.511999130249023, 150, 146, 122, 3, 'Left-Cerebral-Cortex'], ["PH'2", -25.523497253439423, -6.1831155708981544, -19.039741946420087, 153, 147, 121, 3, 'Left-Cerebral-Cortex'], ["PH'3", -28.951394378705018, -6.65323132108708, -19.567484762591153, 156, 147, 121, 2, 'Left-Cerebral-White-Matter'], ["PH'4", -32.37929150397061, -7.123347071276006, -20.095227578762216, 160, 148, 120, 3, 'Left-Cerebral-Cortex'], ["PH'5", -35.80718862923621, -7.593462821464932, -20.62297039493328, 163, 148, 120, 2, 'Left-Cerebral-White-Matter'], ["PH'6", -39.23508575450181, -8.063578571653858, -21.150713211104346, 167, 149, 119, 3, 'Left-Cerebral-Cortex'], ["PH'7", -42.6629828797674, -8.533694321842784, -21.67845602727541, 170, 149, 119, 3, 'Left-Cerebral-Cortex'], ["PH'8", -46.090880005033, -9.003810072031712, -22.206198843446472, 174, 150, 118, 2, 'Left-Cerebral-White-Matter'], ["PH'9", -49.518777130298595, -9.473925822220636, -22.73394165961754, 177, 150, 118, 2, 'Left-Cerebral-White-Matter'], ["PH'10", -52.94667425556419, -9.944041572409564, -23.261684475788602, 180, 151, 118, 3, 'Left-Cerebral-Cortex'], ["PH'11", -56.374571380829785, -10.414157322598488, -23.78942729195967, 184, 151, 117, 3, 'Left-Cerebral-Cortex'], ["PH'12", -59.80246850609538, -10.884273072787416, -24.317170108130732, 187, 152, 117, 0, 'Unknown'], ["T'1", -39.47800064086914, 13.5871000289917, 2.5769999027252197, 167, 125, 141, 3, 'Left-Cerebral-Cortex'], ["T'2", -42.74706701300453, 12.34536315320219, 2.7229265482634477, 170, 125, 140, 3, 'Left-Cerebral-Cortex'], ["T'3", -46.01613338513993, 11.10362627741268, 2.8688531938016757, 174, 125, 139, 2, 'Left-Cerebral-White-Matter'], ["T'4", -49.28519975727532, 9.861889401623168, 3.014779839339904, 177, 124, 137, 2, 'Left-Cerebral-White-Matter'], ["T'5", -52.55426612941072, 8.620152525833658, 3.160706484878132, 180, 124, 136, 3, 'Left-Cerebral-Cortex'], ["T'6", -55.82333250154612, 7.378415650044148, 3.30663313041636, 183, 124, 135, 3, 'Left-Cerebral-Cortex'], ["T'7", -59.0923988736815, 6.136678774254638, 3.452559775954588, 187, 124, 134, 0, 'Unknown'], ["T'8", -62.3614652458169, 4.894941898465127, 3.598486421492816, 190, 124, 132, 0, 'Unknown'], ["T'9", -65.6305316179523, 3.6532050226756176, 3.7444130670310445, 193, 124, 131, 0, 'Unknown'], ["T'10", -68.8995979900877, 2.411468146886106, 3.890339712569272, 196, 124, 130, 0, 'Unknown'], ["TA'1", -46.962100982666016, 33.20539855957031, -7.392000198364258, 174, 135, 161, 2, 'Left-Cerebral-White-Matter'], ["TA'2", -50.076770527843635, 32.51880339753615, -5.950674174241227, 178, 133, 160, 3, 'Left-Cerebral-Cortex'], ["TA'3", -53.19144007302126, 31.83220823550199, -4.509348150118196, 181, 132, 159, 3, 'Left-Cerebral-Cortex'], ["TA'4", -56.30610961819889, 31.145613073467832, -3.0680221259951646, 184, 131, 159, 3, 'Left-Cerebral-Cortex'], ["TA'5", -59.42077916337651, 30.459017911433673, -1.6266961018721338, 187, 129, 158, 3, 'Left-Cerebral-Cortex'], ["TA'6", -62.53544870855413, 29.77242274939951, -0.18537007774910208, 190, 128, 157, 0, 'Unknown'], ["TA'7", -65.65011825373176, 29.08582758736535, 1.2559559463739287, 193, 126, 157, 0, 'Unknown'], ["TA'8", -68.76478779890938, 28.399232425331192, 2.6972819704969595, 196, 125, 156, 0, 'Unknown'], ["W'1", -36.07600021362305, -27.309499740600586, -4.177000045776367, 164, 132, 100, 2, 'Left-Cerebral-White-Matter'], ["W'2", -39.087414904386435, -29.072798221872787, -4.445626228784653, 167, 132, 98, 2, 'Left-Cerebral-White-Matter'], ["W'3", -42.09882959514982, -30.83609670314499, -4.714252411792939, 170, 132, 97, 2, 'Left-Cerebral-White-Matter'], ["W'4", -45.11024428591321, -32.59939518441719, -4.9828785948012255, 173, 132, 95, 3, 'Left-Cerebral-Cortex'], ["W'5", -48.1216589766766, -34.36269366568939, -5.251504777809512, 176, 133, 93, 3, 'Left-Cerebral-Cortex'], ["W'6", -51.13307366743999, -36.12599214696159, -5.520130960817798, 179, 133, 91, 3, 'Left-Cerebral-Cortex'], ["W'7", -54.144488358203375, -37.88929062823379, -5.788757143826084, 182, 133, 90, 3, 'Left-Cerebral-Cortex'], ["W'8", -57.15590304896676, -39.65258910950599, -6.05738332683437, 185, 134, 88, 0, 'Unknown']]
    
    subject_nodes = pd.DataFrame(subject_nodes)
    new_header = subject_nodes.iloc[0] #grab the first row for the header
    subject_nodes = subject_nodes[1:] #take the data less the header row
    subject_nodes.columns = new_header #set the header row as the df header
    
    def is_it_the_area(x, region):
        if region == 'cortex':
            area = ['Left-Cerebral-Cortex','Right-Cerebral-Cortex','Unknown']
        elif region == 'hippo':
            area = ['Left-Hippocampus','Right-Hippocampus']
        elif region == 'amy':
            area = ['Left-Amygdala','Right-Amygdala']
        elif region == 'all':
            area = ['Left-Cerebral-Cortex','Right-Cerebral-Cortex','Unknown', 'Left-Hippocampus','Right-Hippocampus','Left-Amygdala','Right-Amygdala']
        if x in  area:
            return True
        else:
            return False
    
    region = input('Area of interest [cortex/hippo/amy/all]: ')
    subject_nodes['cortex'] = subject_nodes['Anatomic Region'].apply(lambda x : is_it_the_area(x,region))
    cortical_channels = subject_nodes[subject_nodes['cortex']==True].Node.to_list()
    single_cortical_electrodes = np.unique([ ''.join((x for x in name if not x.isdigit())) for name in cortical_channels]).tolist()
    all_cortical_electrodes = [[name for name in cortical_channels if electrode == ''.join((x for x in name if not x.isdigit()))] for electrode in single_electrodes]
    all_cortical_electrodes = [x for x in all_cortical_electrodes if x]
    
    if len(all_cortical_electrodes)==0:
        print('No electrodes in the '+region)


#%% Average response across channels


conditions = ['LaN','LaS']

for channel_set in cortical_channels:
    
    evoked = []
    for condition in conditions:
        condition_epochs = epochs[condition].pick_channels([channel_set]).apply_baseline((4,5))
        condition_epochs.crop(8,11)
        avg_epochs_evoked = condition_epochs.average(method='mean');
        evoked.append(avg_epochs_evoked)
        
    evoked_LaN = evoked[0].get_data(units='uV')
    RMS_LaN = np.sqrt(np.square(evoked_LaN).mean(axis=0))

    evoked_LaS = evoked[1].get_data(units='uV')
    RMS_Las = np.sqrt(np.square(evoked_LaS).mean(axis=0))

    diff_RMS = RMS_LaN -RMS_Las
    
    n_reps = 10000
    consecutive_time = round(20/1000*raw.info['sfreq']) #20ms
    sample_mean = []
    for i in range(n_reps):
        start_sample = random.randint(0,len(diff_RMS)-consecutive_time)
        end_sample = start_sample+consecutive_time
        avg = round(np.mean(diff_RMS[start_sample:end_sample]))
        sample_mean.append(avg)
    ratio_zero = sample_mean.count(0)/len(sample_mean)
    ratio_non_zero = 1 - ratio_zero
    
    if ratio_non_zero > 0.99:
        title = np.unique([ ''.join((x for x in name if not x.isdigit())) for name in [channel_set]]).tolist()[0]
        mne.viz.plot_compare_evokeds(dict(LaN=evoked[0], LaS=evoked[1]),legend='upper left', title=title)
        

#%% Time-freq analysis


significant_channels = []
significant_freqs = []

for channels_of_interest in all_cortical_electrodes:
    
    n_ch = len(channels_of_interest)
    if n_ch == 1: 
        channels_of_interest = channels_of_interest + [ ''.join([i for i in channels_of_interest[0] if not i.isdigit()]) + str(int(re.search(r'\d+', channels_of_interest[0]).group())+1) ]
        n_ch = len(channels_of_interest)
    
    print('\n')
    print('Channels of interest')
    print(channels_of_interest)
    
    print('\n TFR')
    epochs = mne.Epochs(reconst_raw, events, event_id, baseline=None, detrend=1, tmax=11, picks=channels_of_interest, preload=True, verbose=False)
    freqs = np.logspace(*np.log10([1, 140]), num=30)
    n_cycles = freqs/2.  # different number of cycle per frequency
    
    power = mne.time_frequency.tfr_morlet(epochs, freqs=freqs, n_cycles=n_cycles, use_fft=True,return_itc=False,decim=decimation_factor, average=False, verbose=False)
    baseline = (4,5)
    power = power.copy().apply_baseline(baseline, mode="logratio").crop(4.9,11)
    
    print('Computing power and representation...')
    for event in event_id:
        # select desired epochs for visualization
        power_ev = power[event]
        n_ch = len(channels_of_interest)
        if n_ch ==1 :
            power_ev.average().plot(yscale='log',cmap="jet",colorbar=True, show=False, verbose=False)
            plt.title(epochs.ch_names, fontsize=10)
            plt.axvline(5, linewidth=3, color="black", linestyle=":")  # event
            plt.axvline(8, linewidth=3, color="black", linestyle=":")  # event
            plt.suptitle(f"TFR ({event})")
            plt.show()
        else:
            fig, axes = plt.subplots(1, n_ch, figsize=(n_ch*10, 4),gridspec_kw={"width_ratios": [10]*n_ch})
            for ch, ax in enumerate(axes[:]):  # for each channel
                power_ev.average().plot([ch], yscale ='log',cmap="jet", axes=ax,colorbar=True, show=False, verbose=False)
                ax.set_title(epochs.ch_names[ch], fontsize=10)
                ax.axvline(5, linewidth=4, color="black", linestyle=":")  # event
                ax.axvline(8, linewidth=4, color="black", linestyle=":")  # event
                if ch != 0:
                    ax.set_ylabel("")
                    ax.set_yticklabels("")
            fig.suptitle(f"TFR ({event})")
            plt.show()
    
    print('Computing differences between conditions...')
    power_epochs = mne.Epochs(reconst_raw, events, event_id, baseline=(4,5), detrend=1, tmax=11, picks=channels_of_interest, preload=True, verbose=False)
    power_epochs = power_epochs.crop(5,11)
    power_freqs = [[0.1,3,'delta'],[3,7,'theta'],[7,13,'alpha'],[13,35,'beta'],[35,140,'gamma']]
    
    for freq_lims in power_freqs:
        freqs = np.linspace(freq_lims[0],freq_lims[1],30)

        power_array_LaS = mne.time_frequency.tfr_array_morlet(power_epochs['LaS'], sfreq=raw.info['sfreq'], freqs=freqs, n_cycles=freqs/2, use_fft=True,decim=decimation_factor, output='power', verbose=False)
        power_array_LaN = mne.time_frequency.tfr_array_morlet(power_epochs['LaN'], sfreq=raw.info['sfreq'], freqs=freqs, n_cycles=freqs/2, use_fft=True,decim=decimation_factor, output='power', verbose=False)
        
        for ch_number,ch_name in enumerate(channels_of_interest):
            
            ch_power_array_LaS = power_array_LaS[:,ch_number,:,:]
            ch_power_array_LaN = power_array_LaN[:,ch_number,:,:]
    
            if len(ch_power_array_LaS) != len(ch_power_array_LaN):
                min_len = np.min([len(ch_power_array_LaS), len(ch_power_array_LaN)])
                ch_power_array_LaS = ch_power_array_LaS[:min_len,:,:]
                ch_power_array_LaN = ch_power_array_LaN[:min_len,:,:]
    
            res = mannwhitneyu(ch_power_array_LaS,ch_power_array_LaN, alternative='less')
            p = res.pvalue
            
            # # Uncomment to plot over freqs and time
            # plt.imshow(p,cmap='jet',aspect='auto',vmin=0,vmax=1,origin='lower')
            # plt.colorbar()
            # plt.title(ch_name+freq_lims[2]+' LaS vs LaN; mean p-val='+str(round(p.mean(),5)))
            # plt.show()
            
            p_time = np.mean(p,axis=0)
            
            consecutive_time = round(50/1000*raw.info['sfreq']) #50ms
            it_is_significant = False
            for k,g in groupby(p_time<0.05):
                consecutive_samples = sum(1 for i in g)
                if k==True and consecutive_samples>=consecutive_time:
                    it_is_significant = True
            
            # for t_point in range(len(p_time)-consecutive_time):
            #     if all(p_time[t_point:t_point+consecutive_time])<0.05:
            #         it_is_significant = True
                    
            
            if it_is_significant:
                time = np.shape(ch_power_array_LaN)[-1]
                plt.axvspan(xmin=0, xmax=time/2-0.01, color='lightskyblue', alpha=0.5)
                plt.axvspan(xmin=time/2, xmax=time, color='yellowgreen', alpha=0.5)
                plt.plot(p_time,label='p-value',color='black')
                plt.axhline(0.05,linestyle='--',color='black',alpha=0.5,label='p-val=0.05')

                plt.ylim((0,1))
                plt.xlim((0,len(p_time)))
                
                area_name = '___'
                if float(subj) == 2:
                    if 'H' in ch_name:
                        if 'P' in ch_name and int(re.search(r'\d+', ch_name).group())>3:
                            area_name = 'parietal'
                        area_name = 'hippocampal'
                    elif 'O' in ch_name:
                        area_name = 'occipital'
                        if 'P' in ch_name:
                            area_name = 'parietal'
                            if 'OP' in ch_name:
                                area_name = 'parieto-occipital sulcus'
                        if 'T' in ch_name:
                            area_name = 'temporo-occipital'
                        if ch_name == 'TO5':
                            area_name = 'temporal'
                    elif ch_name == 'L2':
                        area_name = 'hippocampal'
                    elif ch_name == 'L9':
                        area_name = 'lateral sulcus'
                    
                        
                if float(subj) == 4:
                    if 'H' in ch_name:
                        if 'P' in ch_name and int(re.search(r'\d+', ch_name).group())>3:
                            area_name = 'parietal'
                        area_name = 'hippocampal'
                    elif 'O' in ch_name:
                        area_name = 'occipital'
                    elif 'TP' in ch_name:
                        area_name = 'temporoparietal'
                
                plt.title('LaN vs LaS difference in '+area_name+' area \n(ch:'+ch_name+'); '+freq_lims[2]+' band',fontsize=15)
                plt.xticks(ticks = np.linspace(0,time,7), labels = np.linspace(0,round(time*decimation_factor/power_epochs.info['sfreq']),7))
                plt.xlabel('Time [s]')
                plt.ylabel('p-value')
                plt.legend(fontsize = 10)
                plt.savefig(ch_name+'_'+freq_lims[2]+'.png', dpi=300)
                plt.show()
                
                significant_channels.append(ch_name)
                significant_freqs.append(freq_lims[2])
                
            else: pass
        
        
#%% ERDS


electrodes = list(np.unique([''.join([i for i in channel if not i.isdigit()]) for channel in significant_channels]))
remaped_channels = []
remaped_freqs = []

for electrode in electrodes: 
    
    pre_chan = []
    pre_freq = []
    for idx, channel in enumerate(significant_channels):
        name = ''.join([i for i in channel if not i.isdigit()])
        if name == electrode:
            pre_chan.append(channel)
            pre_freq.append(significant_freqs[idx])
    
    
    names = list(np.unique(pre_chan))
    if len(names) == 1:
        num = int(re.search(r'\d+', names[0]).group())
        list_nums = [int(re.search(r'\d+', x).group()) for x in all_channels.ch_names if electrode in x]
        if num == 1: 
            names = names + [electrode+str(list_nums[1])]
        else: 
            names = names + [electrode+str(list_nums[list_nums.index(num)-1])]
            
    remaped_channels.append( names )
    remaped_freqs.append( list(np.unique(pre_freq)))


for idx, channels_of_interest in enumerate(remaped_channels):

    freqs = np.logspace(*np.log10([1, 140]), num=30)    

    n_cycles = freqs/2

    print('\nPower as a percentage')
    # Compute power again but as a percent
    epochs = mne.Epochs(reconst_raw, events, event_id, baseline=None, detrend=1, tmax=11, picks=channels_of_interest, preload=True, verbose = False)
    baseline = (4,5)
    power = mne.time_frequency.tfr_morlet(epochs, freqs=freqs, n_cycles=n_cycles, use_fft=True,return_itc=False,decim=decimation_factor, average=False, verbose=False)
    power = power.copy().apply_baseline(baseline, mode="percent").crop(4,11)

    print('\nERDS')
    # Clusters
    freqs = np.arange(1, 140)
    vmin, vmax = -1,1  # set min and max ERDS values in plot
    
    cnorm = TwoSlopeNorm(vmin=vmin, vcenter=0, vmax=vmax)  # min, center & max ERDS
    kwargs = dict(n_permutations=100, step_down_p=0.05, seed=1, buffer_size=None, out_type='mask')  # for cluster test
    
    for event in event_id:
        print('for the '+event+' event')
        # select desired epochs for visualization
        power_ev = power[event]
        n_ch = len(channels_of_interest)
        fig, axes = plt.subplots(1, n_ch, figsize=(n_ch*6, 4), gridspec_kw={"width_ratios": [10]*n_ch})
        for ch, ax in enumerate(axes[:]):  # for each channel
            # positive clusters
            _, c1, p1, _ = pcluster_test(power_ev.data[:, ch], tail=1, **kwargs, verbose=False)
            # negative clusters
            _, c2, p2, _ = pcluster_test(power_ev.data[:, ch], tail=-1, **kwargs, verbose=False)
    
            # note that we keep clusters with p <= 0.05 from the combined clusters
            # of two independent tests; in this example, we do not correct for
            # these two comparisons
            c = np.stack(c1 + c2, axis=2)  # combined clusters
            p = np.concatenate((p1, p2))  # combined p-values
            mask = c[..., p < 0.05].any(axis=-1)
    
            ax.axvspan(xmin=5, xmax=7.95, color='lightskyblue', alpha=0.5)
            ax.axvspan(xmin=8, xmax=11, color='yellowgreen', alpha=0.5)
    
            # plot TFR (ERDS map with masking)
            power_ev.average().plot([ch], cmap="RdBu", cnorm=cnorm, axes=ax,colorbar=True, show=False, mask=mask, mask_style="mask", verbose=False)
    
            ax.set_title(epochs.ch_names[ch], fontsize=20)
            # ax.axvline(5, linewidth=3, color="lightskyblue", linestyle=":")  # event
            # ax.axvline(8, linewidth=3, color="yellowgreen", linestyle=":")  # event
            if ch != 0:
                ax.set_ylabel("")
                ax.set_yticklabels("")
        fig.suptitle(f"ERD/ERS ({event})", y=1.1)
        fig.savefig(str(idx)+'_clusters_'+event+'.png', dpi=300)
        plt.show()


    print('\nConverting results into dataframe')
    df = power.to_data_frame(time_format=None, long_format=True)
    
    # Map to frequency bands:
    freq_bounds = {'_': 0,
                   'delta': 4,
                   'theta': 8,
                   'alpha': 13,
                   'beta': 30,
                   'gamma': 140}
    df['band'] = pd.cut(df['freq'], list(freq_bounds.values()),labels=list(freq_bounds)[1:])
    
    # Filter to retain only relevant frequency bands:
    # freq_bands_of_interest = remaped_freqs[idx]
    freq_bands_of_interest = ['alpha','beta']
    
    df = df[df.band.isin(freq_bands_of_interest)]
    df['band'] = df['band'].cat.remove_unused_categories()
    
    df['channel'] = df['channel'].cat.reorder_categories(channels_of_interest, ordered=True)
    
    sns.set(font_scale=1.5)
    g = sns.FacetGrid(df, row='band', col='channel', margin_titles=True)
    axvspan_kw = dict(color='lightskyblue', alpha=0.5)
    g.map(plt.axvspan, xmin=5, xmax=7.95, **axvspan_kw)
    axvspan_kw = dict(color='yellowgreen', alpha=0.5)
    g.map(plt.axvspan, xmin=8, xmax=11, **axvspan_kw)
    g.map(sns.lineplot, 'time', 'value', 'condition', n_boot=100, legend=None)
    axline_kw = dict(color='black', linestyle='dashed', linewidth=2, alpha=0.5)
    g.map(plt.axhline, y=0, **axline_kw)
    g.set(xlim=(4,11))
    # g.map(plt.axvline, x=5, **axline_kw)
    # g.map(plt.axvline, x=8, **axline_kw)
    g.set_axis_labels("Time (s)", "ERD/ERS (%)")
    g.set_titles(col_template="{col_name}", row_template="{row_name}")
    g.add_legend()
    g.fig.subplots_adjust(left=0.1, right=0.9, top=0.9, bottom=0.08)
    
    fig = g.fig.get_figure()
    fig.savefig(str(idx)+'_ERDS_percent.png', dpi=300)
